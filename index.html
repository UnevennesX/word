<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evannescence Word (v24.2 - Persistent Multi-Select)</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- CSS (Sin cambios) -->
    <style>
        /* ... (Tu CSS existente sin cambios) ... */
        :root{--bg-dark-L1:#1e1e1e;--bg-dark-L2:#2a2a2a;--bg-dark-L3:#3f3f3f;--text-color-primary:#cccccc;--text-color-secondary:#999999;--border-color:#4a4a4a;--accent-color:#4e8cff;--button-hover-bg:#454545;--button-selected-bg:#555555;--button-selected-border:#777777;--error-color:#ff6b6b;--success-color:#6bff8d;--font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';--page-width: 8.5in;--page-height: 11in;--page-padding: 1in;--page-gap: 25px;--current-zoom: 1;}
        *{margin:0;padding:0;box-sizing:border-box;} html { height: 100%; } body{font-family:var(--font-family);background-color:var(--bg-dark-L1);color:var(--text-color-primary);font-size:13px;overflow:hidden;height:100%;display:flex;flex-direction:column;} .app-container{display:flex;flex-direction:column;height:100%;overflow: hidden;} body.global-source-mode-active .main-content { display: none; } body.global-source-mode-active .source-view-global-container { display: flex; }
        .ribbon-bar {background-color:var(--bg-dark-L2);padding: 8px 15px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.2);flex-shrink: 0;flex-wrap: wrap;gap: 8px;justify-content: space-between;} .ribbon-left-center-groups {display: flex;flex-wrap: wrap;gap: 8px;align-items: center;} .ribbon-right-menu {display: flex;align-items: center;gap: 8px;margin-left: auto;flex-shrink: 0;} .ribbon-group{display:flex;align-items:center;gap:4px; position: relative; } .ribbon-group.vertical { flex-direction: column; align-items: flex-start; gap: 3px; background-color: var(--bg-dark-L1); padding: 4px 6px; border-radius: 3px;} .ribbon-group.vertical label { font-size: 10px; color: var(--text-color-secondary); margin-bottom: 2px;} .ribbon-separator{width:1px;height:24px;background-color:var(--border-color);margin:0 6px; flex-shrink: 0;} .icon-button, .action-button, select { background-color: var(--bg-dark-L3); border: 1px solid var(--border-color); color: var(--text-color-primary); padding: 5px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; height: 30px; font-size: 13px; transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease; position: relative; flex-shrink: 0; } .icon-button { min-width: 30px; font-size: 15px; } .action-button { padding: 5px 12px; gap: 6px; font-weight: 500; } select { padding: 5px 8px; } .font-select { width: 150px; } .font-size-select { width: 70px; } #page-size-select { width: auto; min-width: 110px; } #heading-select { width: auto; min-width: 100px; } .icon-button:hover:not(:disabled), .action-button:hover:not(:disabled), select:hover { background-color: var(--button-hover-bg); border-color: var(--button-selected-border); } .icon-button.selected:not(:disabled), .action-button.selected:not(:disabled) { background-color: var(--button-selected-bg); border-color: var(--button-selected-border); color: var(--accent-color); } .ribbon-bar .action-button#save-button { background-color: var(--accent-color); color: var(--bg-dark-L1); border-color: transparent; } .ribbon-bar .action-button#save-button:hover { background-color: #6aa1ff; opacity: 0.9; } button:disabled, select:disabled { opacity: 0.4; cursor: not-allowed; } .icon-button:disabled:hover { background-color: var(--bg-dark-L3); border-color: var(--border-color); } .color-picker-wrapper { position: relative; display: inline-block; } .color-indicator { display: block; width: 18px; height: 4px; background-color: var(--text-color-primary); margin-top: 2px; border: 1px solid var(--border-color); border-radius: 1px; } .color-picker-wrapper input[type="color"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; } .icon-button[title]:hover::after, .action-button[title]:hover::after, select[title]:hover::after {content:attr(title);position:absolute;top:115%;left:50%;transform:translateX(-50%);background-color:rgba(40,40,40,0.95);color:var(--text-color-primary);padding:4px 8px;border-radius:3px;font-size:11px;white-space:nowrap;z-index:1050;pointer-events:none;opacity:0;transition:opacity 0.2s ease 0.1s;} .icon-button[title]:hover:hover::after, .action-button[title]:hover:hover::after, select[title]:hover:hover::after {opacity:1;} .page-size-group-wrapper { display: flex; align-items: flex-end; gap: 8px; } #page-size-preview { width: 24px; height: 30px; background-color: var(--bg-dark-L1); border: 1px solid var(--border-color); border-radius: 2px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; flex-shrink: 0; } #page-size-preview-inner { background-color: var(--text-color-secondary); transition: width 0.2s ease, height 0.2s ease; width: 80%; height: 80%; }
        .table-picker-popup { display: none; position: absolute; top: 100%; left: 0; background-color: var(--bg-dark-L2); border: 1px solid var(--border-color); box-shadow: 0 4px 8px rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; z-index: 1010; width: auto; } .table-picker-popup.visible { display: block; } #table-picker-dimension-display { font-size: 11px; color: var(--text-color-secondary); text-align: center; margin-bottom: 8px; min-height: 1.2em; } .table-picker-grid { display: grid; grid-template-columns: repeat(10, 18px); grid-template-rows: repeat(10, 18px); gap: 3px; cursor: pointer; } .table-picker-cell { width: 18px; height: 18px; background-color: var(--bg-dark-L3); border: 1px solid var(--border-color); transition: background-color 0.1s ease, border-color 0.1s ease; } .table-picker-cell.highlighted { background-color: var(--accent-color); border-color: var(--button-selected-border); }
        .main-content{flex-grow: 1;padding: var(--page-gap);background-color:var(--bg-dark-L1);overflow: auto;display: flex;flex-direction: column;align-items: center;}
        .page-container{background-color:var(--bg-dark-L3);width:var(--page-width);min-height: var(--page-height);height: auto;padding:var(--page-padding);box-shadow:0 2px 15px rgba(0,0,0,0.4);border-radius:2px;transform-origin: top center;transition: transform 0.1s ease-out, opacity 0.3s ease-out;transform: scale(var(--current-zoom, 1));flex-shrink: 0;position: relative;margin-bottom: var(--page-gap);} .page-container:last-child {margin-bottom: 0;} .page-container.new-page-entering { opacity: 0; transform: translateY(15px) scale(var(--current-zoom, 1)); }
        .document-area{ width:100%; min-height: calc(var(--page-height) - (2 * var(--page-padding))); background-color:transparent; border:none; outline:none; color:var(--text-color-primary); font-family:var(--font-family); font-size:12pt; line-height:1.6; padding:0; caret-color:var(--accent-color); word-wrap: break-word; } .document-area p { margin: 0 0 0.5em 0; } .document-area h1, .document-area h2, .document-area h3 { margin: 0.8em 0 0.4em 0; line-height: 1.3; font-weight: bold; } .document-area h1 { font-size: 2em; } .document-area h2 { font-size: 1.5em; } .document-area h3 { font-size: 1.17em; } .document-area table { border-collapse: collapse; margin: 1em 0; width: auto; background-color: transparent; color: inherit; border: 1px solid var(--text-color-primary); } .document-area th, .document-area td { border: 1px solid var(--text-color-primary); min-width: 30px; } .document-area td { padding: 2px 4px; } .document-area td p:first-child:last-child:has(br):not(:has(*:not(br))) { margin: 0; } .document-area:empty::before { content: "Escribe aquí..."; color: var(--text-color-secondary); position: absolute; pointer-events: none; } .document-area::selection{background-color:var(--accent-color);color:var(--bg-dark-L1);}
        /* Source View Global */
        .source-view-global-container { flex-grow: 1; background-color: var(--bg-dark-L1); padding: 15px; overflow: hidden; display: none; /* Oculto por defecto */ flex-direction: column; /* Ajuste para textarea */ }
        .source-view-global-textarea { flex-grow: 1; background-color: var(--bg-dark-L2); color: var(--text-color-primary); border: 1px solid var(--border-color); outline: none; font-family: 'Courier New', monospace; font-size: 10pt; line-height: 1.4; resize: none; white-space: pre-wrap; overflow: auto; tab-size: 4; -moz-tab-size: 4; }
        /* Status Bar */
        .status-bar{background-color:var(--bg-dark-L2);padding:5px 15px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-color);min-height:30px; height: auto; font-size:11px;color:var(--text-color-secondary);flex-shrink:0;flex-wrap: wrap; gap: 5px 10px;}
        .status-left, .status-right{display:flex;align-items:center;gap:10px;white-space: nowrap; flex-basis: auto;}
        .status-bar .icon-button, .status-bar .action-button { height:24px; min-width:24px; font-size:14px; background-color: var(--bg-dark-L3); flex-shrink: 0; } .status-bar .action-button { font-size: 11px; padding: 4px 10px; gap: 5px;} .status-bar .icon-button:hover:not(:disabled), .status-bar .action-button:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--button-selected-border); } .status-bar .action-button.selected { background-color: var(--button-selected-bg); border-color: var(--button-selected-border); color: var(--accent-color); } .zoom-slider-container{width:100px;display:flex;align-items:center;} .zoom-slider{ width:100%;height:4px;cursor:pointer;appearance:none;background:var(--border-color);border-radius:2px;outline:none;transition:background 0.15s ease;} .zoom-slider:hover{background:var(--text-color-secondary);} .zoom-slider::-webkit-slider-thumb{appearance:none;width:14px;height:14px;background:var(--text-color-primary);border-radius:50%;cursor:pointer;border:1px solid var(--border-color);} .zoom-slider::-moz-range-thumb{width:14px;height:14px;background:var(--text-color-primary);border-radius:50%;cursor:pointer;border:1px solid var(--border-color);} .zoom-percentage{min-width:45px;text-align:right;font-weight:500;} .status-separator { color: var(--border-color); margin: 0 5px; } .status-message{padding:0 5px;border-radius:3px;transition:opacity 0.3s ease; opacity: 0; white-space: nowrap;} .status-message.success{color:var(--success-color);} .status-message.error{color:var(--error-color);} .status-message:not(:empty) { opacity: 1; }
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; } .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; } .modal-dialog { background-color: var(--bg-dark-L2); padding: 25px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color: var(--text-color-primary); width: auto; min-width: 300px; max-width: 90%; } .modal-dialog h3 { margin-top: 0; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-weight: 500; } .modal-dialog .form-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; } .modal-dialog label { width: 60px; text-align: right; font-size: 12px; color: var(--text-color-secondary); flex-shrink: 0; } .modal-dialog input[type="text"], .modal-dialog select { flex-grow: 1; background-color: var(--bg-dark-L1); border: 1px solid var(--border-color); color: var(--text-color-primary); padding: 6px 8px; border-radius: 3px; height: 30px; font-size: 13px; } .modal-dialog input[type="text"] { width: 80px; flex-grow: 0; } .modal-dialog select { width: 70px; flex-grow: 0; cursor: pointer; } .modal-dialog .modal-actions { margin-top: 25px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; } .modal-dialog .modal-button { padding: 6px 15px; border-radius: 3px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background-color 0.2s ease, border-color 0.2s ease; height: 30px; border: 1px solid var(--border-color); } .modal-button.primary { background-color: var(--accent-color); color: var(--bg-dark-L1); border-color: transparent; } .modal-button.primary:hover { background-color: #6aa1ff; } .modal-button.secondary { background-color: var(--bg-dark-L3); color: var(--text-color-primary); } .modal-button.secondary:hover { background-color: var(--button-hover-bg); }
        /* Mobile */
        @media (max-width: 768px) {.ribbon-bar { padding: 6px 8px; flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; gap: 6px; -webkit-overflow-scrolling: touch; } .ribbon-left-center-groups, .ribbon-right-menu { flex-wrap: nowrap; } .ribbon-right-menu { margin-left: 0; } .font-select { width: 120px; } .font-size-select { width: 60px; } .main-content { padding: 10px; align-items: stretch; } .page-container { width: 100%; max-width: 100%; padding: 15px; min-height: auto; margin-bottom: 15px; border-radius: 0; box-shadow: none; border: none; background-color: var(--bg-dark-L2); } .page-container:last-child { margin-bottom: 0; } .document-area { min-height: 150px; } .source-view-global-container { padding: 10px; } .status-bar { justify-content: center; /* Centrar grupos en móvil si hacen wrap */ } .status-left, .status-right { justify-content: center; /* Centrar items dentro de grupo */ flex-basis: auto; /* Ajustar tamaño */ } .zoom-slider-container { width: 80px; } .modal-dialog { min-width: 90%; max-width: 95%; } .modal-dialog .form-group { flex-wrap: wrap; } .modal-dialog label { width: auto; text-align: left; flex-basis: 100%; margin-bottom: 3px; } .modal-dialog input[type="text"], .modal-dialog select { flex-grow: 1; width: auto; min-width: 60px; } }
        /* Clase para ocultar/mostrar vista fuente */
        body.global-source-active .main-content { display: none; }
        body.global-source-active .source-view-global-container { display: flex; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Ribbon Bar -->
        <header class="ribbon-bar" id="ribbon-bar">
             <div class="ribbon-left-center-groups">
                <div class="ribbon-group edit-controls"> <button class="icon-button" id="undo-button" data-command="undo" title="Deshacer (Ctrl+Z)"><i class="fas fa-undo"></i></button> <button class="icon-button" id="redo-button" data-command="redo" title="Rehacer (Ctrl+Y)"><i class="fas fa-redo"></i></button> </div>
                <div class="ribbon-separator"></div>
                 <div class="ribbon-group page-layout-controls page-size-group-wrapper"> <div class="vertical"> <label for="page-size-select">Tamaño:</label> <select id="page-size-select" title="Tamaño Hoja"> <option value="letter" selected>Carta</option> <option value="legal">Legal</option> <option value="a4">A4</option> <option value="a5">A5</option> <option value="custom">Personalizado...</option> </select> </div> <div id="page-size-preview" title="Proporción"> <div id="page-size-preview-inner"></div> </div> </div>
                <div class="ribbon-separator"></div>
                 <div class="ribbon-group font-controls"> <select class="font-select" id="font-family-select" data-command="fontName" title="Fuente"> <option value="Arial">Arial</option> <option value="Times New Roman">Times New Roman</option> <option value="Courier New">Courier New</option> <option value="Verdana">Verdana</option> <option value="Georgia">Georgia</option> <option value="Segoe UI">Segoe UI</option> </select> <select class="font-size-select" id="font-size-select" data-command="fontSize" title="Tamaño Fuente"> <option value="1">8pt</option> <option value="2">10pt</option> <option value="3" selected>12pt</option> <option value="4">14pt</option> <option value="5">18pt</option> <option value="6">24pt</option> <option value="7">36pt</option> </select> <div class="color-picker-wrapper" title="Color Fuente"> <button class="icon-button" id="text-color-button"> <i class="fas fa-font"></i> <span class="color-indicator" id="text-color-indicator"></span> </button> <input type="color" id="text-color-input" value="#cccccc"> </div> <button class="icon-button" id="clear-formatting-button" data-command="removeFormat" title="Borrar Formato"><i class="fas fa-eraser"></i></button> </div>
                <div class="ribbon-separator"></div>
                 <div class="ribbon-group formatting-controls"> <button class="icon-button" id="bold-button" data-command="bold" title="Negrita"><i class="fas fa-bold"></i></button> <button class="icon-button" id="italic-button" data-command="italic" title="Cursiva"><i class="fas fa-italic"></i></button> <button class="icon-button" id="underline-button" data-command="underline" title="Subrayado"><i class="fas fa-underline"></i></button> <button class="icon-button" id="strikethrough-button" data-command="strikeThrough" title="Tachado"><i class="fas fa-strikethrough"></i></button> </div>
                <div class="ribbon-separator"></div>
                 <div class="ribbon-group heading-controls"> <select id="heading-select" data-command="formatBlock" title="Estilo Párrafo"> <option value="p">Párrafo</option> <option value="h1">Encabezado 1</option> <option value="h2">Encabezado 2</option> <option value="h3">Encabezado 3</option> </select> </div>
                <div class="ribbon-separator"></div>
                <div class="ribbon-group indent-controls"> <button class="icon-button" id="outdent-button" data-command="outdent" title="Disminuir Sangría (Bloque)"><i class="fas fa-outdent"></i></button> <button class="icon-button" id="indent-button" data-command="indent" title="Aumentar Sangría (Bloque)"><i class="fas fa-indent"></i></button> </div>
                <div class="ribbon-separator"></div>
                 <div class="ribbon-group paragraph-controls"> <button class="icon-button" id="align-left-button" data-command="justifyLeft" title="Alinear Izquierda"><i class="fas fa-align-left"></i></button> <button class="icon-button" id="align-center-button" data-command="justifyCenter" title="Centrar"><i class="fas fa-align-center"></i></button> <button class="icon-button" id="align-right-button" data-command="justifyRight" title="Alinear Derecha"><i class="fas fa-align-right"></i></button> <button class="icon-button" id="align-justify-button" data-command="justifyFull" title="Justificar"><i class="fas fa-align-justify"></i></button> </div>
                 <div class="ribbon-separator"></div>
                <div class="ribbon-group insert-controls"> <button class="action-button" id="manual-page-break-button" title="Insertar Salto Página"><i class="fas fa-file-alt"></i> Salto Pág</button> <div style="position: relative;"> <button class="icon-button" id="insert-table-button" title="Insertar Tabla"> <i class="fas fa-table"></i> </button> <div class="table-picker-popup" id="table-picker-popup"> <div id="table-picker-dimension-display">Selecciona tamaño</div> <div class="table-picker-grid" id="table-picker-grid"></div> </div> </div> </div>
           </div>
            <div class="ribbon-right-menu"> <div class="ribbon-group file-controls"> <button class="action-button" id="save-button" title="Guardar"><i class="fas fa-save"></i> Guardar</button> </div> </div>
        </header>

        <!-- Área Principal -->
        <main class="main-content" id="main-content">
            <div class="page-container" id="page-container-1">
               <div class="document-area" id="document-area-1" contenteditable="true" spellcheck="true">
                   <p>Texto inicial página 1.</p>
                   <p>Más contenido para seleccionar.</p>
               </div>
            </div>
            <div class="page-container" id="page-container-2">
               <div class="document-area" id="document-area-2" contenteditable="true" spellcheck="true">
                   <p>Contenido de la <strong>segunda</strong> página.</p>
                   <p>Prueba seleccionar todo (Ctrl+E) y aplicar negrita.</p>
               </div>
            </div>
        </main>

        <!-- Contenedor para Vista Fuente Global -->
        <div class="source-view-global-container" id="source-view-global-container" style="display: none;">
            <textarea class="source-view-global-textarea" id="source-view-global-textarea" spellcheck="false" readonly></textarea>
        </div>

        <!-- Barra de Estado -->
        <footer class="status-bar">
           <div class="status-left">
               <span id="page-count">Página ? de ?</span>
               <span class="status-separator">|</span>
               <span id="word-count">0 palabras</span>
               <span class="status-separator">|</span>
               <span title="Pasos para Deshacer" style="display: inline-flex; align-items: center; gap: 3px;">
                   <i class="fas fa-undo" style="font-size: 10px;"></i> <span id="undo-count">0</span>
               </span>
               <span class="status-separator">/</span>
                <span title="Pasos para Rehacer" style="display: inline-flex; align-items: center; gap: 3px;">
                   <i class="fas fa-redo" style="font-size: 10px;"></i> <span id="redo-count">0</span>
               </span>
               <span class="status-message" id="status-message-area"></span>
           </div>
           <div class="status-right">
               <button class="action-button" id="source-view-button" title="Ver/Ocultar HTML Global"><i class="fas fa-code"></i> Fuente </button>
               <span class="status-separator">|</span>
               <button class="icon-button" id="zoom-out-button" title="Alejar"><i class="fas fa-minus"></i></button>
               <div class="zoom-slider-container"> <input type="range" min="50" max="200" value="100" step="10" class="zoom-slider" id="zoom-slider-input"> </div>
               <button class="icon-button" id="zoom-in-button" title="Acercar"><i class="fas fa-plus"></i></button>
               <span class="zoom-percentage" id="zoom-percentage-display">100%</span>
           </div>
       </footer>

        <!-- Modal Tamaño Página Personalizado -->
        <div class="modal-overlay" id="custom-size-modal-overlay"> <div class="modal-dialog" id="custom-size-modal-dialog"> <h3>Tamaño Personalizado</h3> <div class="form-group"> <label for="custom-width-input">Ancho:</label> <input type="text" id="custom-width-input"> <select id="custom-width-unit"> <option value="in">in</option> <option value="mm">mm</option> <option value="cm">cm</option> <option value="px">px</option> </select> </div> <div class="form-group"> <label for="custom-height-input">Alto:</label> <input type="text" id="custom-height-input"> <select id="custom-height-unit"> <option value="in">in</option> <option value="mm">mm</option> <option value="cm">cm</option> <option value="px">px</option> </select> </div> <div class="form-group"> <label for="custom-padding-input">Padding:</label> <input type="text" id="custom-padding-input"> <select id="custom-padding-unit"> <option value="in">in</option> <option value="mm">mm</option> <option value="cm">cm</option> <option value="px">px</option> </select> </div> <div class="modal-actions"> <button class="modal-button secondary" id="custom-size-cancel">Cancelar</button> <button class="modal-button primary" id="custom-size-ok">Aceptar</button> </div> </div> </div>
   </div> <!-- Fin .app-container -->

   <!-- Script Combinado ÚNICO (v24.2 - Fix applyCommandToAllPages + Persistencia Lógica) -->
   <script>
       "use strict";
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM References ---
             const mainContent = document.getElementById('main-content');
             const sourceViewGlobalContainer = document.getElementById('source-view-global-container');
             const sourceViewGlobalTextarea = document.getElementById('source-view-global-textarea');
             const ribbonBar = document.getElementById('ribbon-bar');
             const statusBar = document.getElementById('status-bar');
             const statusMessageArea = document.getElementById('status-message-area');
             const wordCountDisplay = document.getElementById('word-count');
             const pageCountDisplay = document.getElementById('page-count');
             const undoButton = document.getElementById('undo-button');
             const redoButton = document.getElementById('redo-button');
             const undoCountDisplay = document.getElementById('undo-count');
             const redoCountDisplay = document.getElementById('redo-count');
             const pageSizeSelect = document.getElementById('page-size-select');
             const pageSizePreview = document.getElementById('page-size-preview-inner');
             const fontFamilySelect = document.getElementById('font-family-select');
             const fontSizeSelect = document.getElementById('font-size-select');
             const textColorButton = document.getElementById('text-color-button');
             const textColorInput = document.getElementById('text-color-input');
             const textColorIndicator = document.getElementById('text-color-indicator');
             const clearFormattingButton = document.getElementById('clear-formatting-button');
             const boldButton = document.getElementById('bold-button');
             const italicButton = document.getElementById('italic-button');
             const underlineButton = document.getElementById('underline-button');
             const strikethroughButton = document.getElementById('strikethrough-button');
             const headingSelect = document.getElementById('heading-select');
             const outdentButton = document.getElementById('outdent-button');
             const indentButton = document.getElementById('indent-button');
             const alignLeftButton = document.getElementById('align-left-button');
             const alignCenterButton = document.getElementById('align-center-button');
             const alignRightButton = document.getElementById('align-right-button');
             const alignJustifyButton = document.getElementById('align-justify-button');
             const manualPageBreakButton = document.getElementById('manual-page-break-button');
             const insertTableButton = document.getElementById('insert-table-button');
             const tablePickerPopup = document.getElementById('table-picker-popup');
             const tablePickerGrid = document.getElementById('table-picker-grid');
             const tableDimensionDisplay = document.getElementById('table-picker-dimension-display');
             const saveButton = document.getElementById('save-button'); // Declarado
             const sourceViewButton = document.getElementById('source-view-button');
             const zoomSliderInput = document.getElementById('zoom-slider-input');
             const zoomPercentageDisplay = document.getElementById('zoom-percentage-display');
             const zoomInButton = document.getElementById('zoom-in-button');
             const zoomOutButton = document.getElementById('zoom-out-button');
             const customSizeModalOverlay = document.getElementById('custom-size-modal-overlay');
             const customSizeModalDialog = document.getElementById('custom-size-modal-dialog');
             const customWidthInput = document.getElementById('custom-width-input');
             const customWidthUnit = document.getElementById('custom-width-unit');
             const customHeightInput = document.getElementById('custom-height-input');
             const customHeightUnit = document.getElementById('custom-height-unit');
             const customPaddingInput = document.getElementById('custom-padding-input');
             const customPaddingUnit = document.getElementById('custom-padding-unit');
             const customSizeOkButton = document.getElementById('custom-size-ok');
             const customSizeCancelButton = document.getElementById('custom-size-cancel');

            // --- State Variables ---
             let currentActiveEditor = null;
             let currentActivePageContainer = null;
             let pageCounter = document.querySelectorAll('.page-container').length;
             let currentStatusTimeout = null;
             let isSourceModeActive = false;
             let currentZoomLevel = 1;
             const PAGE_SIZES_INTERNAL = { letter: { w: 8.5, h: 11, u: 'in', p: 1 }, legal: { w: 8.5, h: 14, u: 'in', p: 1 }, a4: { w: 210, h: 297, u: 'mm', p: 25 }, a5: { w: 148, h: 210, u: 'mm', p: 20 } };
             let currentPageSizeKey = 'letter'; // Declarado
             let currentCustomSize = { w: 8.5, h: 11, u: 'in', p: 1, pu: 'in' };
             let previousPageSizeKey = 'letter';
             const EMPTY_PARAGRAPH_HTML = '<p><br></p>';
             const PAGE_BREAK_CURSOR_THRESHOLD = 1.8;
             const TABLE_PICKER_MAX_ROWS = 10;
             const TABLE_PICKER_MAX_COLS = 10;
             const TAB_CHAR = '\u0009';
             let savedSelectionRange = null;
             const MOBILE_WIDTH_THRESHOLD = 768;
             let isMultiPageSelectionActive = false;
             let editorActiveBeforeMultiSelect = null;
             let activeEditorIdBeforeUndoRedo = null;

             // --- History State (Global) ---
             let historyStates = [];
             let historyIndex = -1;
             const MAX_HISTORY_STATES = 100;
             let inputDebounceTimeout = null;
             const INPUT_DEBOUNCE_DELAY = 800;
             const PAGE_BREAK_SEPARATOR = '\n\n<!-- PAGE BREAK -->\n\n';

            // --- Utility Functions ---
            function showStatusMessage(message, isError = false, duration = 3000) { if (currentStatusTimeout) clearTimeout(currentStatusTimeout); if(statusMessageArea) { statusMessageArea.textContent = message; statusMessageArea.className = `status-message ${isError ? 'error' : 'success'}`; currentStatusTimeout = setTimeout(() => { statusMessageArea.textContent = ''; statusMessageArea.className = 'status-message'; currentStatusTimeout = null; }, duration); } }
            function updatePageCount() { const pages = mainContent.querySelectorAll('.page-container'); const totalPages = pages.length; let currentPageIndex = -1; if (currentActivePageContainer) { currentPageIndex = Array.from(pages).indexOf(currentActivePageContainer); } if(pageCountDisplay) pageCountDisplay.textContent = `Página ${currentPageIndex >= 0 ? currentPageIndex + 1 : '?'} de ${totalPages}`; }
            function updateWordCount() { let totalWords = 0; if (!isSourceModeActive) { const editorDivs = mainContent.querySelectorAll('.document-area'); editorDivs.forEach(div => { const text = div.textContent.trim(); const words = text.length === 0 ? [] : text.split(/\s+/).filter(Boolean); totalWords += words.length; }); } if(wordCountDisplay) wordCountDisplay.textContent = `${totalWords} ${totalWords === 1 ? 'palabra' : 'palabras'}`; }

            // --- History Functions (Global State) ---
            function updateHistoryCounts() { const undoCount = historyIndex >= 0 ? historyIndex + 1 : 0; const redoCount = historyStates.length - 1 - historyIndex; if (undoCountDisplay) undoCountDisplay.textContent = undoCount; if (redoCountDisplay) redoCountDisplay.textContent = redoCount; if (undoButton) undoButton.disabled = isSourceModeActive || undoCount <= 0; if (redoButton) redoButton.disabled = isSourceModeActive || redoCount <= 0; }
            function captureHistoryState(forceCapture = false) {
                if (isSourceModeActive || !mainContent) return;
                const currentStateHTML = mainContent.innerHTML;
                const previousStateHTML = historyIndex >= 0 ? historyStates[historyIndex]?.mainHTML : null;
                const currentActiveEditorId = currentActiveEditor ? currentActiveEditor.id : null;
                if (!forceCapture && currentStateHTML === previousStateHTML) return;
                if (historyIndex < historyStates.length - 1) { historyStates = historyStates.slice(0, historyIndex + 1); }
                historyStates.push({ mainHTML: currentStateHTML, activeEditorId: currentActiveEditorId });
                if (historyStates.length > MAX_HISTORY_STATES) { historyStates.shift(); historyIndex--; }
                historyIndex++;
                historyIndex = Math.min(historyIndex, historyStates.length - 1);
                updateHistoryCounts();
            }
             function restoreEditorState(stateIndex) {
                 let editorToFocusAfterRestore = null; // Guardar ID para enfocar después
                 if (stateIndex < 0 || stateIndex >= historyStates.length) {
                      if (stateIndex === -1) {
                           const initialHTML = historyStates[0]?.mainHTML;
                           if (initialHTML) { mainContent.innerHTML = initialHTML; editorToFocusAfterRestore = historyStates[0].activeEditorId; }
                           else { mainContent.innerHTML = `<div class="page-container" id="page-container-1"><div class="document-area" id="document-area-1" contenteditable="true" spellcheck="true">${EMPTY_PARAGRAPH_HTML}</div></div>`; editorToFocusAfterRestore="document-area-1"; }
                      } else { console.warn(`Índice de historial inválido: ${stateIndex}`); return; }
                 } else {
                     const state = historyStates[stateIndex];
                     editorToFocusAfterRestore = state.activeEditorId; // ID del editor que estaba activo
                     mainContent.innerHTML = state.mainHTML;
                 }
                 // Re-encontrar referencias y re-añadir listeners
                 mainContent.querySelectorAll('.document-area').forEach(editor => { addListenersToEditor(editor); });
                 currentActiveEditor = editorToFocusAfterRestore ? document.getElementById(editorToFocusAfterRestore) : mainContent.querySelector('.document-area');
                 if(currentActiveEditor) currentActivePageContainer = currentActiveEditor.closest('.page-container'); else currentActivePageContainer = null;

                 updatePageCount(); updateWordCount(); updateToolbarStates(); applyZoom(); updateHistoryCounts();

                 // Intentar restaurar el foco y el cursor (después de que el DOM se haya actualizado)
                 if (currentActiveEditor) {
                      setTimeout(() => {
                          currentActiveEditor.focus();
                          try { const range = document.createRange(); const sel = window.getSelection(); range.selectNodeContents(currentActiveEditor); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); } catch (e) {}
                      }, 50); // Un pequeño retraso puede ayudar
                 }
            }
            function customUndo() { if (isSourceModeActive || historyIndex < 0) return; console.log("Undo Global..."); historyIndex--; restoreEditorState(historyIndex); }
            function customRedo() { if (isSourceModeActive || historyIndex >= historyStates.length - 1) return; console.log("Redo Global..."); historyIndex++; restoreEditorState(historyIndex); }

            // --- Core Functions ---
             function applyCommand(command, value = null) {
                 if (isSourceModeActive) return;
                 const isUndoRedo = command === 'undo' || command === 'redo';
                 if(isUndoRedo) return; // Se manejan con custom...

                 if (isMultiPageSelectionActive && ['bold', 'italic', 'underline', 'strikeThrough', 'removeFormat', 'fontName', 'fontSize', 'foreColor', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull', 'formatBlock', 'indent', 'outdent'].includes(command)) {
                     applyCommandToAllPages(command, value); // Llama a la función multi-página
                 } else if (currentActiveEditor) {
                     if(isMultiPageSelectionActive) { console.warn(`Comando '${command}' no soportado globalmente. Aplicando solo a ${currentActiveEditor.id}`); }
                     currentActiveEditor.focus();
                     try { document.execCommand(command, false, value); }
                     catch (error) { console.error(`Error executing command "${command}" en editor activo:`, error); showStatusMessage(`Error: ${command}`, true); return; }
                     setTimeout(() => { captureHistoryState(); updateToolbarStates(); }, 50); // Capturar estado global
                 } else { console.warn("applyCommand llamado sin editor activo."); }
             }

             // --- applyCommandToAllPages (Revisada v24.1) ---
             function applyCommandToAllPages(command, value = null) {
                 const visibleEditors = mainContent.querySelectorAll('.page-container:not(.source-mode-active) .document-area');
                 if (visibleEditors.length === 0) { isMultiPageSelectionActive = false; return; }
                 console.log(`Aplicando comando '${command}' a ${visibleEditors.length} páginas (v24.1)...`);
                 const selection = window.getSelection();
                 const originalActiveEditor = currentActiveEditor;

                 selection.removeAllRanges(); // Limpiar antes de empezar

                 visibleEditors.forEach(editor => {
                     const editorRange = document.createRange();
                     editorRange.selectNodeContents(editor);
                     selection.addRange(editorRange);
                     try {
                         // Forzar foco puede ser necesario
                         // editor.focus();
                         document.execCommand(command, false, value);
                         console.log(`Comando '${command}' aplicado a ${editor.id}`);
                     } catch (error) { console.error(`Error aplicando '${command}' al editor ${editor.id}:`, error); }
                     selection.removeAllRanges(); // Limpiar después de cada editor
                 });

                 if (originalActiveEditor) {
                      originalActiveEditor.focus();
                      const finalRange = document.createRange();
                      finalRange.selectNodeContents(originalActiveEditor);
                      finalRange.collapse(false);
                       try { selection.addRange(finalRange); } catch(e) {}
                 }
                 // --- NO RESETEAR isMultiPageSelectionActive aquí ---
                 // isMultiPageSelectionActive = false;
                 showStatusMessage(`Comando '${command}' aplicado a todas las páginas. Selección mantenida lógicamente.`, false, 2000);
                 setTimeout(() => {
                     captureHistoryState(true); // Forzar captura del estado final
                     updateToolbarStates(); // Actualizar botones
                 }, 60);
             }


            function updateToolbarStates() {
                 const disableFormatControls = !currentActiveEditor || isSourceModeActive;
                 ribbonBar.querySelectorAll('button:not(#undo-button):not(#redo-button):not(#source-view-button):not(#zoom-in-button):not(#zoom-out-button), select').forEach(el => el.disabled = disableFormatControls);
                 if(saveButton) saveButton.disabled = disableFormatControls;
                 if (sourceViewButton) sourceViewButton.disabled = false;
                 if (zoomInButton) zoomInButton.disabled = false;
                 if (zoomOutButton) zoomOutButton.disabled = false;
                 if (zoomSliderInput) zoomSliderInput.disabled = false;
                 updateHistoryCounts();
                 if (sourceViewButton) sourceViewButton.classList.toggle('selected', isSourceModeActive);
                 if ((!currentActiveEditor || isSourceModeActive)) { ribbonBar.querySelectorAll('.selected:not(#source-view-button)').forEach(el => el.classList.remove('selected')); if (textColorIndicator) textColorIndicator.style.backgroundColor = 'var(--text-color-primary)'; if (fontFamilySelect) fontFamilySelect.value = ''; if (fontSizeSelect) fontSizeSelect.value = '3'; if (headingSelect) headingSelect.value = 'p'; return; }
                 // Si hay selección multi-página, no intentar actualizar los estados de formato basados en la selección actual (que sería solo de una página)
                 if (isMultiPageSelectionActive) {
                      console.log("updateToolbarStates: Saltando actualización de formato debido a multi-selección activa.");
                      return;
                  }
                 const toggleCommands = ['bold', 'italic', 'underline', 'strikeThrough', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'];
                 toggleCommands.forEach(cmd => { const button = ribbonBar.querySelector(`[data-command="${cmd}"]`); if (button) { try { button.classList.toggle('selected', document.queryCommandState(cmd)); } catch (e) { console.warn(`Could not query state for ${cmd}`, e); button.classList.remove('selected'); } } });
                 try { const currentFontValue = document.queryCommandValue('fontName'); const currentFont = currentFontValue ? currentFontValue.replace(/['"]/g, '') : ''; if (fontFamilySelect) { if (currentFont) { const match = Array.from(fontFamilySelect.options).find(opt => opt.value.toLowerCase() === currentFont.toLowerCase() || opt.text.toLowerCase() === currentFont.toLowerCase()); fontFamilySelect.value = match ? match.value : ''; } else { fontFamilySelect.value = ''; } } } catch (e) { if (fontFamilySelect) fontFamilySelect.value = ''; }
                 try { const currentSize = document.queryCommandValue('fontSize'); if (fontSizeSelect) fontSizeSelect.value = currentSize || '3'; } catch (e) { if (fontSizeSelect) fontSizeSelect.value = '3'; }
                 try { let currentBlock = document.queryCommandValue('formatBlock').toLowerCase(); if (!currentBlock || currentBlock === 'div') { currentBlock = 'p'; } if (headingSelect) { const isValidOption = Array.from(headingSelect.options).some(opt => opt.value === currentBlock); headingSelect.value = isValidOption ? currentBlock : 'p'; } } catch (e) { if (headingSelect) headingSelect.value = 'p'; }
                 try { let color = document.queryCommandValue('foreColor'); let finalColor = '#cccccc'; if (color) { if (color.startsWith('rgb')) { try { const rgb = color.match(/\d+/g).map(Number); finalColor = '#' + rgb.map(x => { const hex = x.toString(16); return hex.length === 1 ? '0' + hex : hex; }).join(''); } catch (err) { finalColor = '#cccccc'; } } else if (color.startsWith('#')) { finalColor = color; } } if (textColorIndicator) textColorIndicator.style.backgroundColor = finalColor; if (textColorInput) textColorInput.value = finalColor; } catch (e) { if (textColorIndicator) textColorIndicator.style.backgroundColor = '#cccccc'; if (textColorInput) textColorInput.value = '#cccccc'; }
            }
            function applyPageSize(sizeKey, customWVal = null, customHVal = null, customPVal = null, customWUnit = 'in', customHUnit = 'in', customPUnit = 'in') { /* ... (sin cambios) ... */ }
            function updatePagePreview(wVal, hVal, wUnit = 'in', hUnit = 'in') { /* ... (sin cambios) ... */ }
            function showCustomSizeModal() { /* ... (sin cambios) ... */ }
            function hideCustomSizeModal() { /* ... (sin cambios) ... */ }

            // --- addListenersToEditor (ya no necesita textarea) ---
            function addListenersToEditor(editorDiv) {
                if (!editorDiv) return;
                editorDiv.addEventListener('input', () => { if (!isSourceModeActive) { updateWordCount(); if (inputDebounceTimeout) clearTimeout(inputDebounceTimeout); inputDebounceTimeout = setTimeout(() => { captureHistoryState(); inputDebounceTimeout = null; }, INPUT_DEBOUNCE_DELAY); } });
                editorDiv.addEventListener('focus', () => { if (!isSourceModeActive) { isMultiPageSelectionActive = false; currentActiveEditor = editorDiv; currentActivePageContainer = editorDiv.closest('.page-container'); document.querySelectorAll('.page-container.active-page').forEach(p => p.classList.remove('active-page')); currentActivePageContainer?.classList.add('active-page'); updateToolbarStates(); updatePageCount(); updateWordCount(); updateHistoryCounts(); } });
                editorDiv.addEventListener('mouseup', () => { if (!isSourceModeActive) { setTimeout(updateToolbarStates, 50); } });
                editorDiv.addEventListener('keyup', (e) => { if (!isSourceModeActive && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Backspace', 'Delete', 'Home', 'End', 'PageUp', 'PageDown'].includes(e.key)) { setTimeout(updateToolbarStates, 50); } });
                editorDiv.addEventListener('keydown', handleKeyDown);
            }

            // --- createNewPage (ya no crea textarea individual) ---
             function createNewPage(afterPageContainer, focusNew = true, initialContent = EMPTY_PARAGRAPH_HTML) {
                 pageCounter++; const newPageId = pageCounter; const newPage = document.createElement('div'); newPage.className = 'page-container new-page-entering'; newPage.id = `page-container-${newPageId}`; newPage.style.width = `var(--page-width)`; newPage.style.minHeight = `var(--page-height)`; newPage.style.setProperty('--current-zoom', currentZoomLevel); newPage.style.transform = `scale(${currentZoomLevel})`;
                 const newEditor = document.createElement('div'); newEditor.className = 'document-area'; newEditor.id = `document-area-${newPageId}`; newEditor.contentEditable = true; newEditor.spellcheck = true; newEditor.innerHTML = initialContent; newEditor.style.minHeight = `calc(var(--page-height) - (2 * var(--page-padding)))`;
                 newPage.appendChild(newEditor);
                 if (afterPageContainer && afterPageContainer.parentNode === mainContent) { afterPageContainer.after(newPage); } else { mainContent.appendChild(newPage); }
                 addListenersToEditor(newEditor);
                 void newPage.offsetWidth; requestAnimationFrame(() => { newPage.classList.remove('new-page-entering'); newPage.style.opacity = 1; }); updatePageCount();
                 setTimeout(() => captureHistoryState(true), 50);
                 if (focusNew && !isSourceModeActive) { requestAnimationFrame(() => { newEditor.focus(); const range = document.createRange(); const sel = window.getSelection(); if(newEditor.firstChild) { range.setStart(newEditor.firstChild, 0); } else { range.setStart(newEditor, 0); } range.collapse(true); sel.removeAllRanges(); sel.addRange(range); newPage.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); updateToolbarStates(); }); }
                 return newEditor;
             }

            // --- handleKeyDown con lógica de selección/borrado multi-página y undo/redo ---
            function handleKeyDown(e) {
                const targetElement = e.target;
                if (isSourceModeActive && targetElement === sourceViewGlobalTextarea) { // Permitir Ctrl+A/Z/Y en textarea global
                    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a') { handled = false; }
                    else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); handled = true; customUndo(); }
                    else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); handled = true; customRedo(); }
                    return;
                }
                if (isSourceModeActive || !targetElement || !targetElement.classList.contains('document-area')) { isMultiPageSelectionActive = false; return; }

                const editor = targetElement;
                editorActiveBeforeMultiSelect = editor;
                if (editor !== currentActiveEditor) { isMultiPageSelectionActive = false; currentActiveEditor = editor; currentActivePageContainer = editor.closest('.page-container'); updatePageCount(); updateToolbarStates(); updateHistoryCounts(); }

                const selection = window.getSelection();
                if (!selection) return;
                const isCollapsed = selection.isCollapsed;
                let handled = false;

                // Ctrl+A (Página Actual)
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a') {
                    e.preventDefault(); handled = true; isMultiPageSelectionActive = false;
                    if (currentActiveEditor) { const range = document.createRange(); range.selectNodeContents(currentActiveEditor); selection.removeAllRanges(); selection.addRange(range); console.log("Seleccionado página actual (Ctrl+A)"); }
                }
                // Ctrl+E (Todo Visible)
                else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'e') {
                     e.preventDefault(); handled = true; isMultiPageSelectionActive = true;
                     const allVisibleEditors = mainContent.querySelectorAll('.page-container:not(.source-mode-active) .document-area');
                     if (allVisibleEditors.length > 0) { const range = document.createRange(); const firstEditor = allVisibleEditors[0]; const lastEditor = allVisibleEditors[allVisibleEditors.length - 1]; try { if (firstEditor.firstChild) { range.setStartBefore(firstEditor.firstChild); } else { range.setStart(firstEditor, 0); } if (lastEditor.lastChild) { range.setEndAfter(lastEditor.lastChild); } else { range.setEnd(lastEditor, 0); } selection.removeAllRanges(); selection.addRange(range); editorActiveBeforeMultiSelect = document.activeElement && document.activeElement.classList.contains('document-area') ? document.activeElement : firstEditor; firstEditor.focus(); console.log("Seleccionado TODAS las páginas (Ctrl+E)"); } catch (err) { console.error("Error seleccionando todo:", err); isMultiPageSelectionActive = false; } }
                     else { isMultiPageSelectionActive = false; console.log("Ctrl+E - No hay páginas visibles."); }
                }
                // Ctrl+Z (Deshacer Global)
                 else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
                     e.preventDefault(); handled = true; isMultiPageSelectionActive = false;
                     customUndo();
                 }
                 // Ctrl+Y (Rehacer Global)
                 else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') {
                     e.preventDefault(); handled = true; isMultiPageSelectionActive = false;
                     customRedo();
                 }
                // Sangría Móvil (Doble Espacio)
                 else if (window.innerWidth <= MOBILE_WIDTH_THRESHOLD && e.key === ' ' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey) {
                      if (isCollapsed && selection.rangeCount > 0) { const range = selection.getRangeAt(0); const container = range.startContainer; const offset = range.startOffset; if (offset > 0 && container.nodeType === Node.TEXT_NODE) { const prevChar = container.textContent.charAt(offset - 1); const isAtIndentablePosition = offset === 1 || /\s/.test(container.textContent.charAt(offset - 2)); if (prevChar === ' ' && isAtIndentablePosition) { e.preventDefault(); handled = true; isMultiPageSelectionActive = false; const deleteRange = document.createRange(); deleteRange.setStart(container, offset - 1); deleteRange.setEnd(container, offset); try { deleteRange.deleteContents(); console.log("Indent móvil (insertando TAB)"); applyCommand('insertText', TAB_CHAR); } catch (delErr) {} } } }
                 }
                 // Borrado Multi-Página (Ctrl+E + Delete/Backspace - BORRA PÁGINAS EXTRA)
                 else if (['Backspace', 'Delete'].includes(e.key) && isMultiPageSelectionActive && !isCollapsed) {
                     e.preventDefault(); handled = true;
                     console.log("Borrando selección multi-página Y páginas extra...");
                     const allPageContainers = mainContent.querySelectorAll('.page-container');
                     const pageToKeep = editorActiveBeforeMultiSelect?.closest('.page-container') || mainContent.querySelector('.page-container');
                     if (!pageToKeep) { console.error("No se encontró página para conservar."); isMultiPageSelectionActive = false; return; }
                     const editorToKeep = pageToKeep.querySelector('.document-area');

                     if (editorToKeep) editorToKeep.innerHTML = EMPTY_PARAGRAPH_HTML;
                     allPageContainers.forEach(container => { if (container !== pageToKeep) container.remove(); });

                     isMultiPageSelectionActive = false;
                     if (editorToKeep) {
                         currentActiveEditor = editorToKeep; currentActivePageContainer = pageToKeep;
                         const range = document.createRange(); range.selectNodeContents(editorToKeep); range.collapse(true);
                         selection.removeAllRanges(); selection.addRange(range); editorToKeep.focus();
                         captureHistoryState(true); // Forzar captura global
                     }
                     updateWordCount(); updatePageCount(); updateToolbarStates();
                     showStatusMessage("Contenido y páginas extra eliminados.", false, 2500);
                 }
                 // Borrado normal de página vacía (Backspace al inicio)
                 else if (isCollapsed && e.key === 'Backspace') {
                     const range = selection.getRangeAt(0); let isAtStart = range.startOffset === 0; if (range.startContainer !== editor && range.startContainer.nodeType === Node.ELEMENT_NODE && range.startOffset === 0) { isAtStart = !range.startContainer.previousSibling && (!range.startContainer.parentNode || range.startContainer.parentNode === editor); } else if (range.startContainer.nodeType !== Node.ELEMENT_NODE) { let node = range.startContainer; let isFirstContentNode = true; while (node && node !== editor) { if (node.previousSibling) { isFirstContentNode = false; break; } node = node.parentNode; } isAtStart = isAtStart && isFirstContentNode; }
                     if (isAtStart) { const isEmpty = editor.innerHTML.trim() === '' || editor.innerHTML.trim().toLowerCase() === EMPTY_PARAGRAPH_HTML.toLowerCase(); if (isEmpty && mainContent.querySelectorAll('.page-container').length > 1) { const currentPageContainer = editor.closest('.page-container'); const prevPageContainer = currentPageContainer?.previousElementSibling; if (prevPageContainer?.classList.contains('page-container')) { const prevEditor = prevPageContainer.querySelector('.document-area'); if (prevEditor) { e.preventDefault(); handled = true; prevEditor.focus(); const prevRange = document.createRange(); const prevSel = window.getSelection(); prevRange.selectNodeContents(prevEditor); prevRange.collapse(false); prevSel.removeAllRanges(); prevSel.addRange(prevRange); currentPageContainer.remove(); currentActiveEditor = prevEditor; currentActivePageContainer = prevPageContainer; updatePageCount(); updateWordCount(); showStatusMessage('Página eliminada', false, 1500); captureHistoryState(true); isMultiPageSelectionActive = false; } } } }
                 }
                 // Enter
                 else if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
                     isMultiPageSelectionActive = false;
                     if (selection.rangeCount > 0 && isCollapsed) { const range = selection.getRangeAt(0).cloneRange(); const editorRect = editor.getBoundingClientRect(); const editorHeight = editor.clientHeight; let cursorRect = null; if (range.getClientRects().length > 0) { cursorRect = range.getClientRects()[0]; } else { const container = range.startContainer; if(container) { const tempRange = document.createRange(); try { tempRange.selectNodeContents(container.nodeType === 3 ? container.parentNode : container); if(tempRange.getClientRects().length > 0) { cursorRect = tempRange.getClientRects()[0]; } } catch (err) {} } } if (cursorRect) { const cursorBottomRelativeToEditor = cursorRect.bottom - editorRect.top; const lineHeight = parseFloat(getComputedStyle(editor).lineHeight) || 20; const threshold = editorHeight - (lineHeight * PAGE_BREAK_CURSOR_THRESHOLD); if (cursorBottomRelativeToEditor >= threshold) { const currentPageContainer = editor.closest('.page-container'); if (currentPageContainer && !currentPageContainer.nextElementSibling) { e.preventDefault(); handled = true; createNewPage(currentPageContainer, true); /* createNewPage ya captura historial */ } } } }
                     if (!handled) { setTimeout(captureHistoryState, 50); setTimeout(updateToolbarStates, 50); }
                  }
                 // Tab
                 else if (e.key === 'Tab' && !e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey) { isMultiPageSelectionActive = false; e.preventDefault(); handled = true; applyCommand('insertText', TAB_CHAR); }
                 // Shift+Tab
                 else if (e.key === 'Tab' && e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey) { isMultiPageSelectionActive = false; let removedTab = false; if (isCollapsed && selection.rangeCount > 0) { const range = selection.getRangeAt(0); const container = range.startContainer; const offset = range.startOffset; if (offset > 0 && container.nodeType === Node.TEXT_NODE) { if (container.textContent.charAt(offset - 1) === TAB_CHAR) { e.preventDefault(); handled = true; removedTab = true; const deleteRange = document.createRange(); deleteRange.setStart(container, offset - 1); deleteRange.setEnd(container, offset); selection.removeAllRanges(); selection.addRange(deleteRange); applyCommand('delete'); } } } if (!removedTab) { e.preventDefault(); handled = true; applyCommand('outdent'); } }
                 // Otros Shortcuts (Sin Ctrl+A/E/Z/Y)
                 else if ((e.ctrlKey || e.metaKey) && !handled) {
                     isMultiPageSelectionActive = false;
                     let command = null;
                     switch (e.key.toLowerCase()) { case 'b': command = 'bold'; break; case 'i': command = 'italic'; break; case 'u': command = 'underline'; break; case 's': if (saveButton) saveButton.click(); handled = true; break; case '\\': command = 'removeFormat'; break; }
                     if(command) { handled = true; e.preventDefault(); applyCommand(command); } // Usa applyCommand
                 }

                 // Teclas normales (letras, números, símbolos, espacio normal)
                  // Si se presiona una tecla imprimible y hay selección multi-página, borrar todo primero
                 if (!handled && e.key.length === 1 && isMultiPageSelectionActive && !isCollapsed) {
                      e.preventDefault(); handled = true;
                      console.log(`Borrando multi-página antes de insertar '${e.key}'...`);
                      const allPageContainers = mainContent.querySelectorAll('.page-container');
                      const pageToKeep = editorActiveBeforeMultiSelect?.closest('.page-container') || mainContent.querySelector('.page-container');
                      if (!pageToKeep) { console.error("No se encontró página para conservar."); isMultiPageSelectionActive = false; return; }
                      const editorToKeep = pageToKeep.querySelector('.document-area');

                      if (editorToKeep) editorToKeep.innerHTML = EMPTY_PARAGRAPH_HTML;
                      allPageContainers.forEach(container => { if (container !== pageToKeep) container.remove(); });

                      isMultiPageSelectionActive = false; // Resetear ANTES de insertar
                      if (editorToKeep) {
                          currentActiveEditor = editorToKeep; currentActivePageContainer = pageToKeep;
                          const range = document.createRange(); const sel = window.getSelection();
                          range.selectNodeContents(editorToKeep); range.collapse(true); // Cursor al inicio
                          sel.removeAllRanges(); sel.addRange(range); editorToKeep.focus();
                          // Insertar el caracter tecleado usando applyCommand
                          applyCommand('insertText', e.key);
                      }
                      updateWordCount(); updatePageCount(); updateToolbarStates();
                      showStatusMessage(`Contenido anterior eliminado.`, false, 1500);
                  }
                 // Si no fue borrado multi-página, y es tecla normal, actualizar toolbar
                 else if (!handled && e.key.length === 1 ) {
                      isMultiPageSelectionActive = false;
                      setTimeout(updateToolbarStates, 50);
                 }

                 // Resetear flag si la selección deja de estar colapsada (y no fue por A o E)
                 // o si se usan teclas de navegación
                 if ((!isCollapsed && !handled) ||
                     (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Home', 'End', 'PageUp', 'PageDown'].includes(e.key) && !e.ctrlKey && !e.metaKey && !e.shiftKey)
                    )
                 {
                     if(isMultiPageSelectionActive) {
                         isMultiPageSelectionActive = false;
                     }
                 }
            } // Fin handleKeyDown

            // --- Source View (GLOBAL - Unificado) ---
            function toggleSourceView() { const enteringSource = !isSourceModeActive; isSourceModeActive = enteringSource; document.body.classList.toggle('global-source-mode-active', enteringSource); const allPageContainers = mainContent.querySelectorAll('.page-container'); const pageToFocus = currentActivePageContainer || allPageContainers[0]; if (enteringSource) { let allHTML = ''; const editors = mainContent.querySelectorAll('.page-container:not(.source-mode-active) .document-area'); editors.forEach((editor, index) => { allHTML += formatHtmlForSource(editor.innerHTML); if (index < editors.length - 1) { allHTML += PAGE_BREAK_SEPARATOR; } }); if(sourceViewGlobalTextarea) sourceViewGlobalTextarea.value = allHTML; if(sourceViewGlobalContainer) sourceViewGlobalContainer.style.display = 'flex'; mainContent.style.display = 'none'; if(sourceViewGlobalTextarea) setTimeout(() => sourceViewGlobalTextarea.focus(), 0); showStatusMessage('Modo Fuente Global (Solo Lectura, con ajuste)', false, 2500); } else { if(sourceViewGlobalContainer) sourceViewGlobalContainer.style.display = 'none'; mainContent.style.display = 'flex'; if (currentActiveEditor) { setTimeout(() => { currentActiveEditor.focus(); try { const range = document.createRange(); const sel = window.getSelection(); range.selectNodeContents(currentActiveEditor); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); } catch (e) {} }, 0); } showStatusMessage('Modo Visual Global activado', false, 1500); } updateToolbarStates(); updateWordCount(); updateHistoryCounts(); }
            function formatHtmlForSource(html) { let indent = '  '; let level = 0; let formatted = ''; html.replace(/></g, '>\n<').split('\n').forEach(line => { let trimmed = line.trim(); if (!trimmed) return; if (trimmed.startsWith('</')) level = Math.max(0, level - 1); formatted += indent.repeat(level) + trimmed + '\n'; if (trimmed.startsWith('<') && !trimmed.startsWith('</') && !trimmed.endsWith('/>') && !['<br>', '<hr>', '<img>', '<input>'].some(tag => trimmed.startsWith(tag))) { level++; } }); return formatted.trim(); }

            // --- Table Insertion (con savedSelectionRange) ---
            function generateTablePickerGrid() { if (!tablePickerGrid) return; tablePickerGrid.innerHTML = ''; for (let r = 0; r < TABLE_PICKER_MAX_ROWS; r++) { for (let c = 0; c < TABLE_PICKER_MAX_COLS; c++) { const cell = document.createElement('div'); cell.classList.add('table-picker-cell'); cell.dataset.row = r + 1; cell.dataset.col = c + 1; tablePickerGrid.appendChild(cell); } } }
            function showTablePicker() { if (!currentActiveEditor || isSourceModeActive) return; const selection = window.getSelection(); if (selection.rangeCount > 0 && currentActiveEditor.contains(selection.anchorNode)) { savedSelectionRange = selection.getRangeAt(0).cloneRange(); } else { currentActiveEditor.focus(); savedSelectionRange = null; } if(tablePickerPopup) tablePickerPopup.classList.add('visible'); document.addEventListener('click', handleOutsideTableClick, true); }
            function hideTablePicker() { if(tablePickerPopup) tablePickerPopup.classList.remove('visible'); if(tablePickerGrid) tablePickerGrid.querySelectorAll('.highlighted').forEach(c => c.classList.remove('highlighted')); if(tableDimensionDisplay) tableDimensionDisplay.textContent = 'Selecciona tamaño'; savedSelectionRange = null; document.removeEventListener('click', handleOutsideTableClick, true); }
            function handleOutsideTableClick(event) { if (tablePickerPopup && !tablePickerPopup.contains(event.target) && event.target !== insertTableButton && !insertTableButton.contains(event.target)) { hideTablePicker(); } }
            function insertTableHtml(rows, cols) { if (!currentActiveEditor || isSourceModeActive) return; if (savedSelectionRange) { const selection = window.getSelection(); selection.removeAllRanges(); selection.addRange(savedSelectionRange); } else { currentActiveEditor.focus(); const range = document.createRange(); range.selectNodeContents(currentActiveEditor); range.collapse(false); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range); } let tableHtml = `<table border='1' style='border-collapse: collapse; width: auto; background-color: transparent;'><tbody>`; for (let r = 0; r < rows; r++) { tableHtml += `<tr>`; for (let c = 0; c < cols; c++) { tableHtml += `<td style='border: 1px solid var(--text-color-primary); padding: 2px 4px;'><p><br></p></td>`; } tableHtml += `</tr>`; } tableHtml += `</tbody></table><p><br></p>`; applyCommand('insertHTML', tableHtml); savedSelectionRange = null; }

            // --- Zoom Functionality ---
             function applyZoom() { const zoomValue = zoomSliderInput ? parseInt(zoomSliderInput.value) : 100; currentZoomLevel = zoomValue / 100; if(zoomPercentageDisplay) zoomPercentageDisplay.textContent = `${zoomValue}%`; document.documentElement.style.setProperty('--current-zoom', currentZoomLevel); mainContent.querySelectorAll('.page-container').forEach(page => { page.style.transform = `scale(${currentZoomLevel})`; }); }

            // --- Initial Setup ---
            document.querySelectorAll('.document-area').forEach(editor => { addListenersToEditor(editor); }); // No necesita textarea
            currentActiveEditor = document.getElementById('document-area-1');
            if (currentActiveEditor) { currentActivePageContainer = currentActiveEditor.closest('.page-container'); }
            else { const firstEditor = mainContent.querySelector('.document-area'); if(firstEditor) { currentActiveEditor = firstEditor; currentActivePageContainer = firstEditor.closest('.page-container'); console.warn("Editor inicial #document-area-1 no encontrado."); } else { console.error("Error crítico: No se encontró editor inicial."); } }
            if (currentActiveEditor) {
                applyPageSize(currentPageSizeKey); updateWordCount(); updatePageCount();
                captureHistoryState(true); // Capturar estado inicial GLOBAL
                updateToolbarStates(); generateTablePickerGrid();
            } else { updateToolbarStates(); }

           // --- Event Listeners ---
            ribbonBar.addEventListener('click', (e) => {
                 const button = e.target.closest('button[data-command]');
                 const colorButton = e.target.closest('#text-color-button');
                 const tableButton = e.target.closest('#insert-table-button');
                 if (button && button.dataset.command === 'undo' && !button.disabled) { customUndo(); return; }
                 if (button && button.dataset.command === 'redo' && !button.disabled) { customRedo(); return; }
                 if (button && !button.disabled) { applyCommand(button.dataset.command, button.dataset.value || null); } // << Usa applyCommand
                 if (colorButton && !colorButton.disabled) { if (textColorInput) textColorInput.click(); }
                 if (tableButton && !tableButton.disabled) { if (!tablePickerPopup.classList.contains('visible')) { showTablePicker(); } else { hideTablePicker(); } }
             });
            ribbonBar.addEventListener('change', (e) => {
                 const select = e.target.closest('select[data-command]');
                 if (select && !select.disabled) { let value = select.value; if (select.dataset.command === 'formatBlock' && value && !value.startsWith('<') && value !== 'p') { value = `<${value}>`; } applyCommand(select.dataset.command, value); } // << Usa applyCommand
             });
            if (textColorInput) { textColorInput.addEventListener('input', (e) => { if (!isSourceModeActive) { applyCommand('foreColor', e.target.value); } }); } // applyCommand captura historial
            if (manualPageBreakButton) { manualPageBreakButton.addEventListener('click', () => { if (currentActiveEditor && !isSourceModeActive) { createNewPage(currentActivePageContainer, true); } }); } // createNewPage captura historial
            if (saveButton) { saveButton.addEventListener('click', () => { const allPagesData = []; document.querySelectorAll('.page-container:not(.source-mode-active) .document-area').forEach(editor => { allPagesData.push({ id: editor.id.replace('document-area-', 'page-container-'), html: editor.innerHTML }); }); localStorage.setItem('editorContentEditableMultiPage', JSON.stringify(allPagesData)); showStatusMessage('Contenido guardado localmente.', false); }); }
            if (sourceViewButton) { sourceViewButton.addEventListener('click', toggleSourceView); }
            if(zoomSliderInput) { zoomSliderInput.addEventListener('input', applyZoom); }
            if(zoomInButton) { zoomInButton.addEventListener('click', () => { if(zoomSliderInput && parseInt(zoomSliderInput.value) < parseInt(zoomSliderInput.max)) { zoomSliderInput.stepUp(); applyZoom(); } }); }
            if(zoomOutButton) { zoomOutButton.addEventListener('click', () => { if(zoomSliderInput && parseInt(zoomSliderInput.value) > parseInt(zoomSliderInput.min)) { zoomSliderInput.stepDown(); applyZoom(); } }); }
            if (pageSizeSelect) { pageSizeSelect.addEventListener('change', (e) => { const selectedValue = e.target.value; if (selectedValue === 'custom') { previousPageSizeKey = currentPageSizeKey; showCustomSizeModal(); } else { applyPageSize(selectedValue); setTimeout(()=>captureHistoryState(true), 50); } }); }
            if (customSizeOkButton) { customSizeOkButton.addEventListener('click', () => { const wVal = customWidthInput.value; const wUnit = customWidthUnit.value; const hVal = customHeightInput.value; const hUnit = customHeightUnit.value; const pVal = customPaddingInput.value; const pUnit = customPaddingUnit.value; applyPageSize('custom', wVal, hVal, pVal, wUnit, hUnit, pUnit); hideCustomSizeModal(); setTimeout(()=>captureHistoryState(true), 50); }); }
            if (customSizeCancelButton) { customSizeCancelButton.addEventListener('click', () => { pageSizeSelect.value = previousPageSizeKey; hideCustomSizeModal(); }); }
            if (customSizeModalOverlay) { customSizeModalOverlay.addEventListener('click', (e) => { if (e.target === customSizeModalOverlay) { pageSizeSelect.value = previousPageSizeKey; hideCustomSizeModal(); } }); }
            const customSizeInputs = [customWidthInput, customWidthUnit, customHeightInput, customHeightUnit, customPaddingInput, customPaddingUnit];
            customSizeInputs.forEach(el => { if (el) { el.addEventListener('input', () => { const wVal = parseFloat(customWidthInput.value); const hVal = parseFloat(customHeightInput.value); if (!isNaN(wVal) && !isNaN(hVal) && wVal > 0 && hVal > 0) { updatePagePreview(wVal, hVal, customWidthUnit.value, customHeightUnit.value); } }); } });
            if (tablePickerGrid) { tablePickerGrid.addEventListener('mouseover', (e) => { if (e.target.classList.contains('table-picker-cell')) { const targetRow = parseInt(e.target.dataset.row); const targetCol = parseInt(e.target.dataset.col); tablePickerGrid.querySelectorAll('.table-picker-cell').forEach(cell => { const cellRow = parseInt(cell.dataset.row); const cellCol = parseInt(cell.dataset.col); cell.classList.toggle('highlighted', cellRow <= targetRow && cellCol <= targetCol); }); if(tableDimensionDisplay) tableDimensionDisplay.textContent = `${targetRow} × ${targetCol}`; } }); tablePickerGrid.addEventListener('click', (e) => { if (e.target.classList.contains('table-picker-cell') && e.target.classList.contains('highlighted')) { const rows = parseInt(e.target.dataset.row); const cols = parseInt(e.target.dataset.col); insertTableHtml(rows, cols); hideTablePicker(); } }); tablePickerGrid.addEventListener('mouseout', (e) => { if (tablePickerGrid.contains(e.relatedTarget)) return; if(tableDimensionDisplay) tableDimensionDisplay.textContent = 'Selecciona tamaño'; tablePickerGrid.querySelectorAll('.highlighted').forEach(c => c.classList.remove('highlighted')); }); }
            document.addEventListener('selectionchange', () => {
                 if (!isSourceModeActive && document.activeElement && document.activeElement.classList.contains('document-area')) {
                     const activeEd = document.activeElement;
                     // Solo actualizar toolbar si el foco está en el editor correcto Y no hay multi-selección activa
                     if (activeEd === currentActiveEditor && !isMultiPageSelectionActive) {
                          setTimeout(updateToolbarStates, 50);
                     }
                 } else if (!document.activeElement || (!document.activeElement.classList.contains('document-area') && document.activeElement !== sourceViewGlobalTextarea)) {
                     isMultiPageSelectionActive = false; // Resetear si se pierde foco
                 }
            });
             // Listener para resetear flag multi-página si se hace clic fuera (excepto ribbon)
              document.addEventListener('click', (e) => {
                  if (!e.target.closest('.document-area') && !e.target.closest('.ribbon-bar') && isMultiPageSelectionActive) {
                      isMultiPageSelectionActive = false;
                      // console.log("Multi-page flag reset by click outside editor/ribbon."); // DEBUG
                  }
              });
              window.addEventListener('blur', () => { // Resetear si se cambia de ventana
                  if (isMultiPageSelectionActive) isMultiPageSelectionActive = false;
              });

            console.log('Evannescence Word (v24.2 - Combined Keys/History/Persistent Multi-Select)');

        }); // End DOMContentLoaded
   </script>
